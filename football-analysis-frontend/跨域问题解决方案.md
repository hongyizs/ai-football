# 跨域问题解决方案

## 问题描述

前端登录时提示跨域错误，这是因为前端直接访问了后端的完整URL，绕过了Vite的代理配置。

## 解决方案

### 1. 前端修改（已完成）

#### 修改API URL配置
将所有组件中的API URL从完整路径改为相对路径：

**修改前：**
```typescript
const apiUrl = 'http://localhost:9000/foot';
```

**修改后：**
```typescript
const apiUrl = '/foot';
```

这样请求会通过Vite代理转发到后端，避免跨域问题。

#### 修改的文件：
- `src/App.tsx`
- `src/components/Login.tsx`
- `src/components/AnalysisList.tsx`
- `.env.development`

### 2. 后端CORS配置（已添加）

在后端添加了`CorsConfig.java`配置类，允许跨域请求。这是一个备用方案，即使Vite代理失效也能正常工作。

**配置内容：**
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOriginPattern("*");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");
        config.setAllowCredentials(true);
        config.setMaxAge(3600L);
        return new CorsFilter(source);
    }
}
```

### 3. Vite代理配置（已存在）

`vite.config.ts`中的代理配置：

```typescript
server: {
  port: 5173,
  proxy: {
    '/foot': {
      target: 'http://localhost:9000',
      changeOrigin: true,
    },
  },
}
```

## 工作原理

### 开发环境
1. 前端运行在 `http://localhost:5173`
2. 前端请求 `/foot/api/auth/login`
3. Vite代理将请求转发到 `http://localhost:9000/foot/api/auth/login`
4. 后端处理请求并返回响应
5. Vite将响应返回给前端

### 生产环境
1. 前端打包后部署到服务器
2. 使用`.env.production`中的完整URL
3. 后端CORS配置允许跨域请求

## 使用步骤

### 1. 重启前端开发服务器

```bash
cd football-analysis-frontend

# 停止当前运行的服务（Ctrl+C）

# 重新启动
pnpm dev
```

### 2. 重启后端服务

```bash
# 停止当前运行的后端（Ctrl+C）

# 重新启动
start.bat
# 或
mvnw.cmd spring-boot:run
```

### 3. 测试登录

1. 打开浏览器访问 `http://localhost:5173`
2. 输入用户名：`admin`
3. 输入密码：`123456`
4. 点击登录

## 验证方法

### 检查网络请求

打开浏览器开发者工具（F12）→ Network标签：

**正确的请求：**
```
Request URL: http://localhost:5173/foot/api/auth/login
Status: 200 OK
```

**错误的请求（跨域）：**
```
Request URL: http://localhost:9000/foot/api/auth/login
Status: (failed) CORS error
```

### 检查控制台

**成功：**
```
登录成功
WebSocket连接成功
```

**失败：**
```
CORS policy: No 'Access-Control-Allow-Origin' header
```

## 常见问题

### Q1: 修改后仍然跨域？

**解决方案：**
1. 确保完全停止了前端开发服务器（Ctrl+C）
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 重新启动前端：`pnpm dev`
4. 硬刷新页面（Ctrl+F5）

### Q2: WebSocket连接失败？

**原因：** WebSocket不能通过HTTP代理

**解决方案：** WebSocket必须使用完整URL：
```typescript
const wsUrl = 'ws://localhost:9000/foot/ws/analysis';
```

这是正常的，WebSocket不受CORS限制。

### Q3: 生产环境如何配置？

**步骤：**
1. 修改`.env.production`中的URL为实际域名
2. 确保后端CORS配置允许该域名
3. 使用`pnpm build`打包前端
4. 部署到服务器

## 环境变量说明

### 开发环境（.env.development）
```env
VITE_API_URL=/foot                                    # 使用相对路径，走代理
VITE_WS_URL=ws://localhost:9000/foot/ws/analysis    # WebSocket使用完整URL
```

### 生产环境（.env.production）
```env
VITE_API_URL=http://your-domain.com/foot             # 使用完整URL
VITE_WS_URL=ws://your-domain.com/foot/ws/analysis   # WebSocket完整URL
```

## 总结

通过以下三层保护，确保跨域问题得到解决：

1. **Vite代理**（开发环境首选）- 性能最好，无需CORS
2. **后端CORS配置**（备用方案）- 即使代理失效也能工作
3. **环境变量配置**（灵活切换）- 开发/生产环境自动适配

现在重启前后端服务，跨域问题应该已经解决！
